<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" class="h-100">
<head th:insert="blocks/includes :: header">
</head>
<body class="bg-dark d-flex flex-column h-100">
<nav th:replace="blocks/header :: header"></nav>
<form style="visibility: hidden; height: 0; width: 0">
    <input type="text" name="botName" th:value="${botName}"/>
</form>
<div class="container card text-center bg-secondary" style="max-width: 512px">
    <img th:src="@{images/logo.png}" class="img-fluid">
    <div class="card-body">
    <a href="#" id="BotLink" class="btn btn-outline-light btn-lg stretched-link w-100">Перейти к боту</a>
    </div>
</div>
<form id="login" action="/login" method="post">
    <input type="text" id="userId" name="userId" class="visually-hidden">
    <input type="text" id="secretKey" name="secretKey" class="visually-hidden">
</form>
<footer th:replace="blocks/footer :: footer"></footer>
<div th:replace="blocks/includes :: footer"></div>
<script th:inline="javascript">
    $(document).ready(function () {
        let eventUrl = "/events/login"
        let botName = $("input[name=botName]").val()
        let eventSource = new EventSource(eventUrl)
        eventSource.addEventListener("INIT", function (event) {
            let url = 'tg://resolve?domain=' + botName + '&start=login=' + event.data
            $('#BotLink').attr("href", url)
        })
        eventSource.addEventListener("LoginData", function (event) {
            let data = JSON.parse(event.data)
            $('#userId').attr("value", data[0])
            $('#secretKey').attr("value", data[1])
            $('#login').submit()
        })
    })
</script>
</body>
</html>